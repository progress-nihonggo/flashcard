
<!doctype html>
<html lang="id">
<head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Flashcard Kanji V4</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;600;800&display=swap" rel="stylesheet">
<style>
:root{--bg:#fff6fb;--card:#fff;--accent:#f6c1d9;--accent2:#ffdce6;--text:#2b2b2b;--muted:#6b7280}
body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;margin:0;background:var(--bg);color:var(--text)}
body.sakura{}
body.dark{--bg:#0f1724;--card:#0b1220;--accent:#6b7280;--accent2:#374151;--text:#e6eef8;--muted:#9aa6b2}
body.light{--bg:#f8fafc;--card:#ffffff;--accent:#e6eef8;--accent2:#dfeffd;--text:#0f172a;--muted:#6b7280}
.container{max-width:980px;margin:20px auto;padding:16px}
.header{display:flex;justify-content:space-between;align-items:center}
.controls{display:flex;gap:8px;align-items:center}
.btn{background:linear-gradient(180deg,var(--accent),var(--accent2));border:0;padding:8px 12px;border-radius:10px;cursor:pointer}
.left{width:260px;padding:12px;background:var(--card);border-radius:10px;box-shadow:0 8px 30px rgba(2,6,23,0.06)}
.main{margin-left:16px;flex:1}
.layout{display:flex;gap:12px}
.welcome{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(255,255,255,0.95),rgba(255,250,253,0.9));z-index:50}
.card{width:540px;height:360px;border-radius:14px;background:var(--card);display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden;box-shadow:0 24px 70px rgba(2,6,23,0.08);transition:transform .45s}
.front,.back{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;backface-visibility:hidden;padding:20px;transition:transform .6s,opacity .3s}
.back{transform:rotateY(-180deg)}
.card.is-flipped .front{transform:rotateY(180deg);opacity:0}
.card.is-flipped .back{transform:rotateY(0deg);opacity:1}
.kanji{font-weight:900;font-size:64px}
.furi{font-size:20px;color:var(--muted);margin-top:8px}
.meta{font-size:13px;color:var(--muted);text-align:center;margin-top:8px}
.levels{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px}
.levels label{display:flex;align-items:center;gap:6px;padding:6px 8px;border-radius:8px;background:rgba(0,0,0,0.02);cursor:pointer}
.hidden{display:none}
.flashAnim{animation:flash 350ms ease-in-out}
@keyframes flash{0%{transform:scale(1)}50%{transform:scale(1.04)}100%{transform:scale(1)}}
@media(max-width:820px){.layout{flex-direction:column}.left{width:100%}.card{width:92vw;height:60vw}}
</style>
</head>
<body class="sakura">
<div class="welcome" id="welcome"><div style="background:var(--card);padding:28px;border-radius:12px;box-shadow:0 30px 80px rgba(2,6,23,0.12);text-align:center;max-width:720px">
<h1 style="margin:0 0 10px">Selamat Datang — Flashcard Kanji</h1>
<p style="color:var(--muted)">Mode Normal untuk latihan; Shiken untuk ujian. Pilih level lalu mulai.</p>
<div style="margin-top:16px"><button id="enter" class="btn">Mulai</button> <button id="enterExam" class="btn">Langsung Shiken</button></div>
</div></div>

<div class="container" id="app" style="display:none">
  <div class="header">
    <div style="font-weight:800">Flashcard Kanji • V4</div>
    <div class="controls">
      <label>Mode <select id="mode"><option value="normal">Normal</option><option value="exam">Shiken</option></select></label>
      <label>Font <select id="font"><option value="default">Default</option><option value="medium">Medium</option><option value="large">Large</option></select></label>
      <label>Tema <select id="theme"><option value="sakura">Sakura</option><option value="dark">Dark</option><option value="light">Light</option></select></label>
      <button id="historyBtn" class="btn">History</button>
    </div>
  </div>

  <div class="layout">
    <div class="left">
      <div><strong>Pilih Level</strong></div>
      <div class="levels" id="levelChecks"></div>
      <div style="margin-top:8px"><label>Jumlah Soal (Auto) <input id="numQ" type="number" value="20" min="1" max="441" style="width:80px"></label></div>
      <div style="margin-top:8px"><label><input type="checkbox" id="shuffleStart" checked> Acak saat mulai</label></div>
      <div style="margin-top:12px;display:flex;gap:8px"><button id="startAuto" class="btn">Mulai Auto</button><button id="startManual" class="btn">Mulai Manual</button></div>
      <div style="margin-top:12px;border-top:1px dashed rgba(0,0,0,0.06);padding-top:10px">
        <div style="margin-bottom:6px"><strong>Kontrol</strong></div>
        <div style="display:flex;gap:6px"><button id="btnPrev" class="btn">Prev</button><button id="btnFlip" class="btn">Flip</button><button id="btnNext" class="btn">Next</button></div>
      </div>
      <div style="margin-top:12px"><button id="clearHistory" class="btn">Hapus History</button></div>
    </div>

    <div class="main">
      <div style="display:flex;flex-direction:column;align-items:center;gap:8px">
        <div class="card" id="card" tabindex="0">
          <div class="front" id="frontFace"><div class="kanji" id="kanji">—</div></div>
          <div class="back hidden" id="backFace"><div class="kanji" id="kanjiBack">—</div><div class="furi" id="furi"></div><div class="meaning" id="meaning"></div></div>
        </div>

        <div style="display:flex;gap:8px;align-items:center">
          <div id="examPanel" class="hidden"><span id="examStatus">Stopped</span> • <span id="countdown"></span> <button id="stopExam" class="btn">Stop</button></div>
          <div id="normalPanel"><button id="uiPrev" class="btn">Prev</button><button id="uiNext" class="btn">Next</button><span class="meta" id="meta">0 / 0 • Level -</span></div>
        </div>

        <div style="width:100%;display:flex;justify-content:space-between"><div style="color:var(--muted)">Total kanji: 441</div><div><button id="endSession" class="btn hidden">End Session</button></div></div>
      </div>
    </div>
  </div>
</div>

<div id="historyModal" class="hidden" style="position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:var(--card);padding:16px;border-radius:10px;box-shadow:0 30px 80px rgba(2,6,23,0.12);max-width:90%;max-height:80%;overflow:auto;z-index:80"></div>

<script>
let kanji = []; let pool = []; let idx = 0; let flipped=false; let timer=null; let remaining=0; let session=null;
const historyKey = 'kanji_flash_history_v4';
const el = id => document.getElementById(id);

const welcome = el('welcome'), app = el('app'), enter = el('enter'), enterExam = el('enterExam');
const mode = el('mode'), theme = el('theme'), font = el('font'), levelChecks = el('levelChecks');
const startAuto = el('startAuto'), startManual = el('startManual'), numQ = el('numQ'), shuffleStart = el('shuffleStart');
const btnPrev = el('btnPrev'), btnFlip = el('btnFlip'), btnNext = el('btnNext');
const card = el('card'), frontFace = el('frontFace'), backFace = el('backFace');
const kanjiEl = el('kanji'), kanjiBack = el('kanjiBack'), furi = el('furi'), meaning = el('meaning');
const uiPrev = el('uiPrev'), uiNext = el('uiNext'), meta = el('meta');
const examPanel = el('examPanel'), normalPanel = el('normalPanel'), examStatus = el('examStatus'), countdown = el('countdown'), stopExam = el('stopExam');
const endSession = el('endSession');
const historyBtn = el('historyBtn'), historyModal = el('historyModal'), clearHistory = el('clearHistory');

enter.onclick = ()=>{ welcome.style.display='none'; app.style.display='block'; };
enterExam.onclick = ()=>{ welcome.style.display='none'; app.style.display='block'; mode.value='exam'; onModeChange(); };

// load kanji.json
fetch('kanji.json').then(r=>r.json()).then(d=>{ kanji = d; buildLevels(); refreshPool(); }).catch(e=>{ console.error(e); alert('Gagal load kanji.json. Pastikan file kanji.json berada di folder yang sama.'); });

function buildLevels(){ const max = Math.max(...kanji.map(x=>x.level)); levelChecks.innerHTML = '<label><input type="checkbox" value="all" id="allLv" checked> Semua</label>'; for(let i=1;i<=max;i++){ const lbl = document.createElement('label'); lbl.innerHTML = `<input type="checkbox" value="${i}" checked> Level ${i}`; levelChecks.appendChild(lbl); } document.getElementById('allLv').addEventListener('change', e=>{ const chs = levelChecks.querySelectorAll('input[type=checkbox]'); chs.forEach(c=>{ if(c!==e.target) c.checked = e.target.checked; }); }); }

function getSelectedLevels(){ const chs = levelChecks.querySelectorAll('input[type=checkbox]'); const sel=[]; chs.forEach(c=>{ if(c.checked && c.value!=='all') sel.push(parseInt(c.value)); }); return sel.length?sel:Array.from(new Set(kanji.map(x=>x.level))).sort(); }

function refreshPool(){ const levels = getSelectedLevels(); pool = kanji.filter(k=> levels.includes(k.level)); meta.textContent = pool.length? (idx+1) + ' / ' + pool.length + ' • Level ' + (pool[idx]?.level||'-') : '0 / 0'; if(pool.length) showCard(0); }

function showCard(i){ if(!pool.length) return; idx = ((i%pool.length)+pool.length)%pool.length; const it = pool[idx]; kanjiEl.textContent = it.kanji; kanjiBack.textContent = it.kanji; furi.textContent = it.furi||''; meaning.textContent = it.meaning||''; flipped=false; frontFace.classList.remove('hidden'); backFace.classList.add('hidden'); card.classList.remove('is-flipped'); meta.textContent = (idx+1)+' / '+pool.length+' • Level '+it.level; }

function flip(){ flipped = !flipped; if(flipped){ card.classList.add('is-flipped'); frontFace.classList.add('hidden'); backFace.classList.remove('hidden'); } else { card.classList.remove('is-flipped'); frontFace.classList.remove('hidden'); backFace.classList.add('hidden'); } }

function nextCard(){ idx = (idx+1)%pool.length; showCard(idx); animate(); }
function prevCard(){ idx = (idx-1+pool.length)%pool.length; showCard(idx); animate(); }
function animate(){ card.classList.add('flashAnim'); setTimeout(()=>card.classList.remove('flashAnim'),350); }

// controls setup
btnNext.onclick = ()=> nextCard(); btnPrev.onclick = ()=> prevCard(); btnFlip.onclick = ()=> flip();
uiNext.onclick = ()=> nextCard(); uiPrev.onclick = ()=> prevCard();
document.addEventListener('keydown', e=>{ if(welcome.style.display!=='none') return; if(e.code==='Space'){ e.preventDefault(); flip(); } if(e.key==='ArrowRight') nextCard(); if(e.key==='ArrowLeft') prevCard(); });

mode.addEventListener('change', onModeChange);
function onModeChange(){ const isExam = mode.value==='exam'; examPanel.classList.toggle('hidden', !isExam); normalPanel.classList.toggle('hidden', isExam); endSession.classList.toggle('hidden', !isExam); stopAuto(); refreshPool(); }

// font and theme
font.addEventListener('change', ()=>{ const v=font.value; if(v==='medium'){ kanjiEl.style.fontSize='72px'; kanjiBack.style.fontSize='72px'; } else if(v==='large'){ kanjiEl.style.fontSize='88px'; kanjiBack.style.fontSize='88px'; } else { kanjiEl.style.fontSize='64px'; kanjiBack.style.fontSize='64px'; } });
theme.addEventListener('change', ()=>{ document.body.classList.remove('sakura','dark','light'); document.body.classList.add(theme.value); });

// start auto
startAuto.onclick = ()=>{
  const num = Math.min(parseInt(numQ.value)||20, pool.length);
  if(!pool.length){ alert('Pilih level dahulu'); return; }
  let sample = pool.slice();
  if(shuffleStart.checked) sample.sort(()=>Math.random()-0.5);
  sample = sample.slice(0,num);
  startAutoRun(sample);
};

function startAutoRun(list){
  session = {mode:'auto',levels:getSelectedLevels(),num:list.length,start:Date.now()};
  pool = list; idx=0; showCard(0);
  mode.value='exam'; onModeChange();
  examStatus.textContent='Running'; let interval = parseInt(document.getElementById('intervalInput')?.value) || 10;
  remaining = interval; countdown.textContent = remaining+'s';
  stopExam.onclick = ()=>{ endExam('stopped'); };
  timer = setInterval(()=>{ remaining--; countdown.textContent = remaining+'s'; if(remaining<=0){ idx++; if(idx>=pool.length){ endExam('finished'); return; } showCard(idx); animate(); remaining=interval; } },1000);
}

// stop auto
function stopAuto(){ if(timer){ clearInterval(timer); timer=null; } countdown.textContent=''; examStatus.textContent='Stopped'; }

stopExam.onclick = ()=>{ endExam('stopped'); };

// start manual
startManual.onclick = ()=>{
  session = {mode:'manual',levels:getSelectedLevels(),num:pool.length,start:Date.now()};
  mode.value='exam'; onModeChange(); examStatus.textContent='Running (Manual)'; endSession.onclick = ()=> endExam('manual-ended');
};

function endExam(reason){
  stopAuto();
  const end = Date.now(); const duration = end - (session?.start||end);
  const report = {id:'sess_'+new Date().toISOString(), mode: session?.mode||'auto', levels: session?.levels||getSelectedLevels(), num: session?.num||pool.length, duration_ms: duration, started_at: new Date(session?.start||Date.now()).toISOString(), ended_at: new Date(end).toISOString(), reason:reason};
  const hist = JSON.parse(localStorage.getItem(historyKey) || "[]"); hist.unshift(report); localStorage.setItem(historyKey, JSON.stringify(hist));
  alert('Ujian selesai • '+report.num+' soal • Durasi: '+Math.floor(report.duration_ms/1000)+'s');
  session=null; mode.value='normal'; onModeChange(); showHistory(true);
}

// history
historyBtn.onclick = ()=> showHistory(false);
function showHistory(openAfterSave){ const hist = JSON.parse(localStorage.getItem(historyKey) || "[]"); let html = '<h3>History Ujian</h3>'; if(!hist.length) html+='<div>Tidak ada history</div>'; else{ html+='<div style="display:flex;flex-direction:column;gap:8px">'; hist.forEach(h=>{ html+=`<div style="padding:8px;border-radius:8px;background:var(--bg);display:flex;justify-content:space-between"><div><div><strong>${h.mode}</strong> • ${h.num} soal</div><div style="font-size:12px;color:var(--muted)">Level: ${h.levels.join(', ')} • ${new Date(h.started_at).toLocaleString()}</div></div><div><button class="btn" onclick="replay('${h.id}')">Replay</button></div></div>`; }); html+='</div>'; } html += '<div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end"><button class="btn" onclick="closeHistory()">Tutup</button><button class="btn" onclick="clearAllHistory()">Hapus Semua</button></div>'; historyModal.innerHTML = html; historyModal.classList.remove('hidden'); if(openAfterSave && hist.length){ const r = hist[0]; alert('Laporan:\nMode: '+r.mode+'\nLevel: '+r.levels.join(', ')+'\nJumlah: '+r.num+'\nDurasi: '+Math.floor(r.duration_ms/1000)+'s'); } }
function closeHistory(){ historyModal.classList.add('hidden'); historyModal.innerHTML=''; }
function clearAllHistory(){ if(confirm('Hapus semua history?')){ localStorage.removeItem(historyKey); alert('History dihapus'); closeHistory(); } }
function replay(id){ alert('Replay belum tersedia. ID='+id); }

levelChecks.addEventListener('change', refreshPool);
numQ.addEventListener('change', ()=>{ if(parseInt(numQ.value)>kanji.length) numQ.value=kanji.length; });
document.getElementById('clearHistory').onclick = ()=>{ clearAllHistory(); };
setTimeout(()=>{ refreshPool(); },250);
</script>
</body>
</html>
